#!/usr/bin/env bash
set -euo pipefail

# List of rsync sources to try, in order.
# Each should point to a directory that contains:
#   - extrausers.tgz
#   - extrausers.tgz.sha256
#
# Examples:
#   "idcache@dir1.example.org:/srv/idcache/"
#   "idcache@dir2:/srv/idcache/"
SOURCES=(
  "idcache@dir1.example.org:/srv/idcache/"
  "idcache@dir2.example.org:/srv/idcache/"
  "idcache@dir3.example.org:/srv/idcache/"
)

# Optional: SSH options for rsync (host key pinning, jump hosts, etc.)
# Create a dedicated /root/.ssh/config entry for 'dir1.example.org' etc., or use RSYNC_RSH inline:
#   RSYNC_RSH="ssh -i /root/.ssh/id_rsa_idcache -o StrictHostKeyChecking=yes"
RSYNC_RSH=${RSYNC_RSH:-"ssh -o StrictHostKeyChecking=yes -o BatchMode=yes -o ConnectTimeout=10"}

OUTDIR="/var/lib/extrausers"
WORK="/var/lib/extrausers.pull"
MAX_AGE_SECONDS=$(( 60 * 60 * 3 ))  # allow up to 3h stale if all sources fail

mkdir -p "$WORK" "$OUTDIR"

downloaded=0
for SRC in "${SOURCES[@]}"; do
  echo "Trying $SRC ..."
  # Use --copy-links so the remote can serve a symlink to the current artifact if desired
  if RSYNC_RSH="$RSYNC_RSH" rsync -avz --copy-links --partial --delete \
        "${SRC}extrausers.tgz" "${SRC}extrausers.tgz.sha256" "$WORK/"; then
    downloaded=1
    break
  else
    echo "rsync failed for $SRC"
  fi
done

if [[ $downloaded -ne 1 ]]; then
  echo "ERROR: could not fetch bundle from any source"
  # Fallback: keep using current files if not too old
  if [[ -f "$OUTDIR/passwd" && -f "$OUTDIR/group" && -f "$OUTDIR/shadow" ]]; then
    age=$(( $(date +%s) - $(stat -c %Y "$OUTDIR/passwd") ))
    if (( age <= MAX_AGE_SECONDS )); then
      echo "Using existing local extrausers (age ${age}s)"
      exit 0
    fi
  fi
  exit 1
fi

pushd "$WORK" >/dev/null

# Verify checksum
if ! sha256sum -c extrausers.tgz.sha256; then
  echo "ERROR: checksum verification failed"
  exit 1
fi

# Extract to staging and validate contents
STAGE="$(mktemp -d -p "$WORK" stage.XXXXXX)"
tar -xzf extrausers.tgz -C "$STAGE"

for f in passwd group shadow; do
  [[ -f "$STAGE/$f" ]] || { echo "Missing $f in bundle"; exit 1; }
done

# Enforce permissions and rotate atomically
install -m 0644 -o root -g root   "$STAGE/passwd" "$OUTDIR/passwd.tmp"
install -m 0644 -o root -g root   "$STAGE/group"  "$OUTDIR/group.tmp"
install -m 0640 -o root -g shadow "$STAGE/shadow" "$OUTDIR/shadow.tmp"

mv -f "$OUTDIR/passwd.tmp" "$OUTDIR/passwd"
mv -f "$OUTDIR/group.tmp"  "$OUTDIR/group"
mv -f "$OUTDIR/shadow.tmp" "$OUTDIR/shadow"

# SELinux (optional)
if command -v restorecon >/dev/null 2>&1; then
  restorecon "$OUTDIR/passwd" "$OUTDIR/group" "$OUTDIR/shadow" || true
fi

popd >/dev/null
echo "Updated /var/lib/extrausers from rsync bundle."
