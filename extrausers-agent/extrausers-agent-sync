#!/usr/bin/env bash
set -euo pipefail

BASE_URL="${BASE_URL:-https://idcache.example.org/idcache}"
WORK="/var/lib/extrausers.pull"
OUTDIR="/var/lib/extrausers"
MAX_AGE_SECONDS="${MAX_AGE_SECONDS:-10800}"

mkdir -p "$WORK" "$OUTDIR"

cd "$WORK"

echo "Fetching bundle..."
curl -fsSLO "${BASE_URL}/extrausers.tgz"
curl -fsSLO "${BASE_URL}/extrausers.tgz.sha256"

sha256sum -c extrausers.tgz.sha256

STAGE="$(mktemp -d)"
tar -xzf extrausers.tgz -C "$STAGE"

for f in passwd group shadow; do
    [[ -f "$STAGE/$f" ]] || { echo "Missing $f"; exit 1; }
done

install -m 0644 -o root -g root   "$STAGE/passwd" "$OUTDIR/passwd.tmp"
install -m 0644 -o root -g root   "$STAGE/group"  "$OUTDIR/group.tmp"
install -m 0640 -o root -g shadow "$STAGE/shadow" "$OUTDIR/shadow.tmp"

mv -f "$OUTDIR/passwd.tmp" "$OUTDIR/passwd"
mv -f "$OUTDIR/group.tmp"  "$OUTDIR/group"
mv -f "$OUTDIR/shadow.tmp" "$OUTDIR/shadow"

echo "extrausers updated from HTTPS"

