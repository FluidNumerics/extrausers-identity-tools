#!/usr/bin/env bash
set -euo pipefail

CONF_DIR="${CONF_DIR:-/etc/extrausers-pull}"
SOURCES_FILE="${SOURCES_FILE:-$CONF_DIR/sources.list}"

WORK="${WORK:-/var/lib/extrausers.pull}"
OUTDIR="${OUTDIR:-/var/lib/extrausers}"

RSYNC_RSH="ssh -l idcache -i /etc/extrausers-pull/idcache_ed25519 \
  -o BatchMode=yes \
  -o StrictHostKeyChecking=yes \
  -o PermitLocalCommand=no"

MAX_AGE_SECONDS="${MAX_AGE_SECONDS:-10800}"   # 3h

mkdir -p "$WORK" "$OUTDIR" "$CONF_DIR"

# Load sources
declare -a SOURCES=()

# 1) env override (space-separated)
if [[ -n "${SOURCES:-}" ]]; then
  # shellcheck disable=SC2206
  SOURCES=(${SOURCES})
fi

# 2) file sources (line-separated) appended if env not set
if [[ ${#SOURCES[@]} -eq 0 && -f "$SOURCES_FILE" ]]; then
  while IFS= read -r line; do
    [[ -z "$line" || "$line" =~ ^# ]] && continue
    SOURCES+=("$line")
  done < "$SOURCES_FILE"
fi

if [[ ${#SOURCES[@]} -eq 0 ]]; then
  echo "ERROR: No sources defined. Set SOURCES env var or create $SOURCES_FILE" >&2
  exit 1
fi

downloaded=0
for SRC in "${SOURCES[@]}"; do
  echo "Trying $SRC ..."
  if RSYNC_RSH="$RSYNC_RSH" rsync -avz --copy-links --partial --delete \
      "${SRC}/extrausers.tgz" "${SRC}/extrausers.tgz.sha256" "$WORK/"; then
    downloaded=1
    break
  else
    echo "rsync failed for $SRC" >&2
  fi
done

if [[ $downloaded -ne 1 ]]; then
  echo "ERROR: could not fetch bundle from any source" >&2
  if [[ -f "$OUTDIR/passwd" && -f "$OUTDIR/group" && -f "$OUTDIR/shadow" ]]; then
    age=$(( $(date +%s) - $(stat -c %Y "$OUTDIR/passwd") ))
    if (( age <= MAX_AGE_SECONDS )); then
      echo "Using existing local extrausers (age ${age}s)"
      exit 0
    fi
  fi
  exit 1
fi

pushd "$WORK" >/dev/null

sha256sum -c extrausers.tgz.sha256

STAGE="$(mktemp -d -p "$WORK" stage.XXXXXX)"
tar -xzf extrausers.tgz -C "$STAGE"

for f in passwd group shadow; do
  [[ -f "$STAGE/$f" ]] || { echo "Missing $f in bundle" >&2; exit 1; }
done

install -m 0644 -o root -g root   "$STAGE/passwd" "$OUTDIR/passwd.tmp"
install -m 0644 -o root -g root   "$STAGE/group"  "$OUTDIR/group.tmp"
install -m 0640 -o root -g shadow "$STAGE/shadow" "$OUTDIR/shadow.tmp"

mv -f "$OUTDIR/passwd.tmp" "$OUTDIR/passwd"
mv -f "$OUTDIR/group.tmp"  "$OUTDIR/group"
mv -f "$OUTDIR/shadow.tmp" "$OUTDIR/shadow"

# SELinux friendly
if command -v restorecon >/dev/null 2>&1; then
  restorecon "$OUTDIR/passwd" "$OUTDIR/group" "$OUTDIR/shadow" || true
fi

popd >/dev/null
echo "Updated $OUTDIR from rsync bundle."

